define(["jquery","jqueryui"],function(a){return{init:function(){function b(b){var c=b.attr("tabindex");c>0&&a(".section.main:visible").each(function(){a(this).attr("tabindex",c)})}function c(){a(document).keyup(function(b){var c=b.keyCode||b.which,d=a(":focus");13==c&&("undefined"!=typeof d.attr("id")&&d.attr("id").indexOf("tab")>-1&&d.click(),"undefined"!=typeof d.attr("id")&&d.attr("id").indexOf("section")>-1&&d.find(".toggler:visible").click())})}function d(b,c,d){a(".tablink").each(function(){a(this).attr("sections",a(this).attr("sections").replace(","+c,"")),a(this).attr("sections",a(this).attr("sections").replace(c+",","")),a(this).attr("sections",a(this).attr("sections").replace(c,"")),a(this).attr("section_nums",a(this).attr("section_nums").replace(","+d,"")),a(this).attr("section_nums",a(this).attr("section_nums").replace(d+",","")),a(this).attr("section_nums",a(this).attr("section_nums").replace(d,""))}),b>0&&(0===a("#tab"+b).attr("sections").length?a("#tab"+b).attr("sections",a("#tab"+b).attr("sections")+c):a("#tab"+b).attr("sections",a("#tab"+b).attr("sections")+","+c),0===a("#tab"+b).attr("section_nums").length?a("#tab"+b).attr("section_nums",a("#tab"+b).attr("section_nums")+d):a("#tab"+b).attr("section_nums",a("#tab"+b).attr("section_nums")+","+d))}function e(b){var c=a("#courseid").attr("courseid");a.ajax({url:"format/topics2/ajax/update_tab_settings.php",type:"POST",data:{courseid:c,tabid:b,sections:a("#"+b).attr("sections"),sectionnums:a("#"+b).attr("section_nums")},success:function(a){""!==a&&console.log(a)}})}var f=function(){a("#changenumsections").on("click",function(){var b=a(".section.main").length;sessionStorage.setItem("numSections",b)})},g=function(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return a.replace(/[&<>"']/g,function(a){return b[a]})},h=function(b){if(a(".limittabname").length>0){var c=a(".limittabname").attr("value"),d=b.attr("tab_title");if(d.length>c){var e=d.substr(0,c)+String.fromCharCode(8230);b.hasClass("tabsectionname")?b.html(e):0===a(".inplaceeditingon").length&&(a(".inplaceeditable").length>0?b.find("a").html(b.find("a").html().replace(g(d),e)):b.html(b.html().replace(g(d),e)))}}},i=function(){a(".limittabname").length>0&&a(".tablink").each(function(){h(a(this))})},j=function(b){if(a(".limittabname").length>0){var c=a(".limittabname").attr("value"),d=b.attr("tab_title");if(d.length>c){var e=d.substr(0,c)+String.fromCharCode(8230);if(b.hasClass("tabsectionname"))b.html(d);else if(0===a(".inplaceeditingon").length)if(a(".inplaceeditable").length>0){var f=b.find(".inplaceeditable").attr("data-value");d!==f&&(b.attr("tab_title",f),d=f,e=d.substr(0,c)+String.fromCharCode(8230)),b.find("a").html(b.find("a").html().replace(g(e),d))}else b.html(b.html().replace(g(e),d))}}},k=function(b,c){console.log("single section in tab: using section name as tab name");var d=c.find(".sectionname:not(.hidden)");if(a(".tabname_backup:visible").length>-1){var e=c.attr("aria-label");b.parent().append(b.clone().addClass("tabname_backup").hide()),b.html(e).addClass("tabsectionname"),b.attr("tab_title",e),0===a(".inplaceeditable").length?(d.hide(),c.find(".sectionhead").hide()):(c.find(".toggler").addClass("toggler_edit_only").hide(),d.addClass("edit_only"))}};a(".section").on("updated",function(){var b=a(this).find(".inplaceeditable").attr("data-value");a(this).attr("aria-label",b),a(".tablink.active").click()});var l=function(b){var c=b.attr("id");b.addClass("hidden-tab"),require(["core/str"],function(d){var e=d.get_string("hidden_tab_hint","format_qmultopics");a.when(e).done(function(d){b.find("#not-shown-hint-"+c).remove();var e='<i id="not-shown-hint-'+c+'" class="fa fa-info" title="'+d+'"></i>';1==b.attr("sections").split(",").length&&a(".single_section_tabs").length>0?b.html(b.html()+" "+e):a(".tablink .fa-pencil").length>0?b.find(".inplaceeditable").append(e):b.html(b.html()+" "+e)})})},m=function(b){var c=b.attr("id");b.removeClass("hidden-tab"),a("#not-shown-hint-"+c).remove()},n=function(b){var c=b.parent().find(".tabname_backup"),d=b.parent().find(".tabsectionname").removeClass("tabsectionname");d.html(c.html()),c.remove(),a(".sectionname").removeClass("edit_only").show(),a(".hidden.sectionname").show(),a(".section-handle").show(),a(".toggler_edit_only").removeClass("toggler_edit_only").show(),console.log("--> restoring section headline ")},o=function(){a(".tablink").on("click",function(){var c=a("#courseid").attr("courseid"),d=a(this).attr("id"),e=a(this).attr("sections"),f=e.split(",");a(".tablink.active").removeClass("active"),a(this).addClass("active"),sessionStorage.setItem("courseid",c),sessionStorage.setItem("tabid",d),a(".limittabname").length>0&&(i(),j(a(this)));var g;a(this).find(".inplaceeditable-text")&&(g=a(this).find(".inplaceeditable-text").attr("data-value")),"undefined"==typeof g&&(g=a(this).html()),console.log('=====> Clicked tab "'+g+'":'),a(".assessment_info_block_content").hide(),a(".tablink.active").removeClass("active"),a(".modulecontent").addClass("active"),a("#content_assessmentinformation_area").hide(),a("#assessment_information_area").hide(),"tab0"===d?(a("#changenumsections").show(),a("li.section").show(),a(".topictab:visible").each(function(){a(this).attr("sections").length>0&&a.each(a(this).attr("sections").split(","),function(b,c){var d=a(".section[section-id='"+c+"']");d.hide(),console.log("--> hiding section "+c)})})):"tab_assessment_information"===d?(a("li.section").hide(),a("li.section.hidden").addClass("hiding"),a("li.section.hiding").removeClass("hidden"),a("#content_assessmentinformation_area").show(),a(".merge_assessment_info").length>0&&(a("#assessment_information_area").show(),a("#content_assessmentinformation_area").show())):"tab_assessment_info_block"===d?(a("li.section").hide(),a("#changenumsections").hide(),a("li.section.hidden").addClass("hiding"),a("li.section.hiding").removeClass("hidden"),a("#assessment_information_area").show()):(a("#changenumsections").show(),a("li.section").hide(),a.each(f,function(b,c){var d=a(".section[section-id='"+c+"']");d.show(),console.log("--> showing section "+c)})),a("#ontop_area #section-0").show();var h=a("li.section:visible").length,o=a("li.section.hidden:visible").length,p=a("#modulecontent").find(".block:visible"),q=a("#content_assessmentinformation_area:visible").length;if(a(".section0_ontop").length>0&&(console.log("section0 is on top - so reducing the number of visible sections for this tab by 1"),h--),h<1&&0===p.length&&0===q){console.log("tab with no visible sections - hiding it"),a(this).parent().hide();var r=a(this).attr("generic_title");a.ajax({url:"format/topics2/ajax/update_tab_name.php",type:"POST",data:{courseid:c,tabid:d,tab_name:r},success:function(b){""!==b&&(console.log("Reset name of tab ID "+d+' to "'+b+'"'),a("[data-itemid="+b+"]").attr("data-value",r).find(".quickeditlink").html(r),u())}})}else console.log("tab with visible sections - showing it"),a(this).parent().show();if(a(".single_section_tabs").length>0&&1==a(this).attr("sections").split(",").length&&"tab0"!==d){var s=a("li.section:visible").first();a(".section0_ontop").length>0&&(s=a("li.section:visible:eq(1)"));var t=s.attr("id");h-o<=1&&"section-0"!==t&&a(this).attr("generic_title").indexOf("Tab")>=0?(k(a(this),s),s.find(".toggle_area").removeClass("hidden").show()):a(".inplaceeditable").length>0&&"section-0"!==t&&n(a(this))}h<=o&&0===p.length&&0===q?l(a(this)):m(a(this)),"tab0"===d&&1===a(".tabitem:visible").length&&a(".tabitem").hide(),b(a(this))})},p=function(){a(".tab_mover").on("click",function(){var b=a(this).attr("tabnr"),c=a(this).closest("li.section").attr("section-id"),d=a(this).closest("li.section").attr("id").substring(8),e=a(".topictab.active").first().attr("id");"undefined"==typeof e&&(e="tab0"),a(".tablink").each(function(){a(this).attr("sections",a(this).attr("sections").replace(","+c,"")),a(this).attr("sections",a(this).attr("sections").replace(c+",","")),a(this).attr("sections",a(this).attr("sections").replace(c,"")),a(this).attr("section_nums",a(this).attr("section_nums").replace(","+d,"")),a(this).attr("section_nums",a(this).attr("section_nums").replace(d+",","")),a(this).attr("section_nums",a(this).attr("section_nums").replace(d,""))}),b>0&&(0===a("#tab"+b).attr("sections").length?a("#tab"+b).attr("sections",a("#tab"+b).attr("sections")+c):a("#tab"+b).attr("sections",a("#tab"+b).attr("sections")+","+c),0===a("#tab"+b).attr("section_nums").length?a("#tab"+b).attr("section_nums",a("#tab"+b).attr("section_nums")+d):a("#tab"+b).attr("section_nums",a("#tab"+b).attr("section_nums")+","+d)),a("#tab"+b).click(),a("#"+e).click(),n(a("#tab"+b));var f=a("li.section:visible").length-(a("#ontop_area").hasClass("section0_ontop")?1:0);f>0&&a("li.section:visible").length>=f?(a("#tab"+b).click(),a("#"+e).click()):(a("#tab"+b).click(),a("#"+e).parent().hide())})},q=function(){a(".ontop_mover").on("click",function(){a("ul#ontop_area").append(a(this).closest(".section")).addClass("section0_ontop"),a("#section-0").removeClass("main")})},r=function(){a(".inline_mover").on("click",function(){var b=a(this).closest(".section").attr("section-id");a("#inline_area").append(a(this).closest(".section")),a("#section-0").addClass("main"),a(".section0_ontop").removeClass("section0_ontop"),a(".tablink").each(function(){return a(this).attr("sections").indexOf(b)>-1&&(a(this).click(),!1)})})},s=function(){a(".menubar").on("click",function(){if(a(this).parent().parent().hasClass("section_action_menu")){var b=a(this).closest(".section").attr("id");a("#"+b+" .tab_mover").show();var c=[],d=[];if(a(".tablink").each(function(){if("undefined"!=typeof a(this).attr("id")){var b="",e=a(this).attr("id").substr(3);b=a(this).hasClass("tabsectionname")?a(this).html():a(this).find(".inplaceeditable").attr("data-value"),a.inArray(e,d)<0&&(a(this).hasClass("hidden-tab")&&(b=a(this).find("a").clone(),b.find("span.quickediticon").remove(),b=a.trim(b.html())),c[e]=b,d.push(e))}}),a(this).parent().find(".tab_mover").each(function(){var b=a(this).attr("tabnr"),d="To Tab "+(""===c[b]||c[b]==="Tab "+b?b:'"'+c[b]+(c[b]==="Tab "+b||"0"===b?'"':'" (Tab '+b+")"));a(this).find(".menu-action-text").html(d)}),"section-0"===b)1===a("#ontop_area.section0_ontop").length?(a("#section-0 .inline_mover").show(),a("#section-0 .tab_mover").addClass("tab_mover_bak").removeClass("tab_mover").hide(),a("#section-0 .ontop_mover").hide()):(a("#section-0 .inline_mover").hide(),a("#section-0 .tab_mover_bak").addClass("tab_mover").removeClass("tab_mover_bak").show(),a("#section-0 .ontop_mover").show());else if("undefined"!=typeof a(".tablink.active").attr("id")){var e=a(".tablink.active").attr("id").substring(3);a("#"+b+' .tab_mover[tabnr="'+e+'"]').hide()}0===a(".tablink:visible").length&&a("#"+b+' .tab_mover[tabnr="0"]').hide()}})},t=function(){a(".section-actions .menubar .action-menu-trigger .dropdown .dropdown-menu .dropdown-item").on("click",function(){var b=a(".tablink.active"),c=a("li.section:visible").length,d=a("li.section.hidden:visible").length,e=a("#modulecontent").find(".block:visible"),f=a("#content_assessmentinformation_area:visible").length;a(this).find(".menu-action-text").html().indexOf("Hide")>=0&&void 0!=b.attr("id")&&c<=d+a(".section0_ontop").length+1&&0===e.length&&0===f&&l(b),a(this).find(".menu-action-text").html().indexOf("Show")>=0&&void 0!=b.attr("id")&&m(b)})},u=function(){o(),p(),q(),r(),s(),f(),c(),t()},v=function(b,c){var d=a(document).find(".course_format_name").html(),e=c.draggable.find(".topictab").first(),f=a(this).find(".topictab").first(),g=e.attr("id"),h=f.attr("id");console.log('The tab with ID "'+g+'" was dropped onto tab with the ID "'+h+'"');var i=e.parent().html();e.parent().html(f.parent().html()),f.parent().html(i),u();var j=[];a(".tablink").each(function(){var b=a(this).attr("id");"undefined"!=typeof b&&(j.includes(b)||j.push(b))});var k=j.join(),l=a("#courseid").attr("courseid");a.ajax({url:"format/topics2/ajax/update_tab_seq.php",type:"POST",data:{courseid:l,tab_seq:k,course_format_name:d},success:function(a){console.log("the new tab sequence: "+a)}})};a("a").click(function(){if("#"!==a(this).attr("href")&&"undefined"!=typeof a(this).attr("href")){var b=a(this).attr("href").split("#")[1];if("undefined"!=typeof b){var c=a("#"+b).attr("section-id"),d=!1;a(".tablink").each(function(){if(a(this).attr("sections").indexOf(c)>-1)return a(this).click(),d=!0,!1}),d||a("#tab0").click()}}}),a(document).ready(function(){console.log("=================< topics2/tabs.js >================="),u(),a(".block_assessment_information").length>0&&(a("#assessment_information_area").append(a(".block_assessment_information")),a(".block").length===a(".block_assessment_information").length&&a("#region-main").removeClass("has-blocks")),a("#section-0 .right.side").show(),i(),a(".inplaceeditable").length>0&&(a(".topictab").parent().draggable({cursor:"move",stack:".tabitem",revert:!0}),a(".topictab").parent().droppable({accept:".tabitem",hoverClass:"hovered",drop:v}));var b=a("#courseid").attr("courseid"),c=sessionStorage.getItem("courseid");if(null!==c&&c==b)var f=sessionStorage.getItem("tabid");else sessionStorage.removeItem("courseid"),sessionStorage.removeItem("tabid");if(a(".topictab:visible").length>0)if(a("#tab0").click(),a(".tablink:visible").click(),null!=f&&"tab0"!=f){var g=sessionStorage.getItem("numSections");if(sessionStorage.removeItem("numSections"),null!=g){var h=f.substring(3),j=0;a(".section.main").each(function(){if(j+=1,j>g){var b=a(this).attr("section-id"),c=a(this).attr("id").substring(8);d(h,b,c)}}),e(f)}a("#"+f).click()}else a(".tablink:visible").first().click();a("#ontop_area").hasClass("section0_ontop")?(a("#section-0 .inline_mover").show(),a("#section-0 .tab_mover").hide(),a("#section-0 .ontop_mover").hide()):(a("#section-0 .inline_mover").hide(),a("#section-0 .tab_mover").show(),a("#section-0 .ontop_mover").show())})}}});